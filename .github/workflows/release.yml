name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:

  # ────────────────────────────────────────────────────────────────────
  # Check whether signing secrets are configured.
  # The `secrets` context is unavailable in job-level `if`, so we expose
  # it as a safe output that downstream jobs reference via `needs`.
  # Extend this job when macOS / Windows notarisation secrets are added.
  # ────────────────────────────────────────────────────────────────────
  check-android-signing:
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.check.outputs.android }}
    steps:
      - id: check
        env:
          KEY: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          [ -n "$KEY" ] && echo "android=true" >> $GITHUB_OUTPUT \
                        || echo "android=false" >> $GITHUB_OUTPUT

  # ────────────────────────────────────────────────────────────────────
  # All native builds — Linux, Windows, Android — in one parallel matrix
  # ────────────────────────────────────────────────────────────────────
  build:
    name: Build (${{ matrix.artifact }})
    needs: check-android-signing
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Linux x86_64 ──────────────────────────────────────────
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bundles: deb,appimage,rpm
            artifact: linux-x86_64
            android: false

          # ── Windows x86_64 ────────────────────────────────────────
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: msi,nsis
            artifact: windows-x86_64
            android: false

          # ── Windows ARM64 (Surface / Snapdragon) ──────────────────
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            bundles: msi
            artifact: windows-aarch64
            android: false

          # ── Android — Tauri native (API 24+, all ABIs) ────────────
          - os: ubuntu-latest
            target: android
            artifact: android-tauri
            android: tauri
            ndk: 27.0.12077973

    steps:
      - uses: actions/checkout@v4

      # ── Rust toolchain (desktop + Tauri Android only) ──────────────
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.android == false && matrix.target || '' }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.artifact }}

      # ── Linux system deps (desktop only) ──────────────────────────
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest' && matrix.android == false
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            rpm

      # ── Java (Android Tauri needs it) ────────────────────────────
      - name: Set up Java
        if: matrix.android != false
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      # ── Tauri Android setup ────────────────────────────────────────
      - name: Setup Android SDK
        if: matrix.android == 'tauri'
        uses: android-actions/setup-android@v3

      - name: Install NDK
        if: matrix.android == 'tauri'
        run: sdkmanager "ndk;${{ matrix.ndk }}"

      - name: Add Android Rust targets
        if: matrix.android == 'tauri'
        run: |
          rustup target add \
            aarch64-linux-android \
            armv7-linux-androideabi \
            x86_64-linux-android \
            i686-linux-android

      # ── Tauri CLI ────────────────────────────────────────────────────
      - uses: cargo-bins/cargo-binstall@main
      - name: Install Tauri CLI
        run: cargo binstall --no-confirm tauri-cli --version "^2"

      - name: Init Android project
        if: matrix.android == 'tauri'
        run: cargo tauri android init
        working-directory: toloo-app
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/${{ matrix.ndk }}

      - name: Setup Tauri Android signing
        if: matrix.android == 'tauri' && needs.check-android-signing.outputs.android == 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # 1. Decode keystore into the app module directory
          echo "$KEYSTORE_BASE64" | base64 -d \
            > toloo-app/src-tauri/gen/android/app/keystore.jks

          # 2. Create keystore.properties (Tauri convention)
          printf 'storeFile=keystore.jks\nstorePassword=%s\nkeyAlias=%s\nkeyPassword=%s\n' \
            "$KEYSTORE_PASSWORD" "$KEY_ALIAS" "$KEY_PASSWORD" \
            > toloo-app/src-tauri/gen/android/keystore.properties

          # 3. Patch build.gradle.kts to read keystore.properties and sign the release APK
          python3 << 'PYEOF'
          import re, pathlib

          gradle = pathlib.Path("toloo-app/src-tauri/gen/android/app/build.gradle.kts")
          src = gradle.read_text()

          # Add import if missing
          if "import java.io.FileInputStream" not in src:
              src = "import java.io.FileInputStream\n" + src

          # Insert signingConfigs block right before buildTypes
          signing = "\n".join([
              "",
              "    signingConfigs {",
              '        create("release") {',
              '            val keystorePropertiesFile = rootProject.file("keystore.properties")',
              "            val keystoreProperties = java.util.Properties()",
              "            if (keystorePropertiesFile.exists()) {",
              "                keystoreProperties.load(FileInputStream(keystorePropertiesFile))",
              "            }",
              '            keyAlias = keystoreProperties["keyAlias"] as String',
              '            keyPassword = keystoreProperties["keyPassword"] as String',
              '            storeFile = file(keystoreProperties["storeFile"] as String)',
              '            storePassword = keystoreProperties["storePassword"] as String',
              "        }",
              "    }",
              "",
          ])
          src = re.sub(r'(\n(\s*)buildTypes\s*\{)', signing + r'\1', src, count=1)

          # Add signingConfig to the release buildType
          src = re.sub(
              r'(getByName\("release"\)\s*\{)',
              r'\1\n            signingConfig = signingConfigs.getByName("release")',
              src, count=1,
          )

          gradle.write_text(src)
          print("build.gradle.kts patched for release signing")
          PYEOF

      # ── Windows: cache Tauri's downloaded bundler tools (WiX, NSIS) ──
      - name: Cache Tauri bundler tools
        if: matrix.os == 'windows-latest' && matrix.android == false
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\tauri
          key: tauri-bundler-tools

      # ── Build ──────────────────────────────────────────────────────
      - name: Build (desktop)
        if: matrix.android == false
        shell: bash
        working-directory: toloo-app
        run: |
          # Retry up to 3 times — WiX/NSIS downloads from GitHub releases
          # are occasionally flaky and fail with "Peer disconnected".
          for attempt in 1 2 3; do
            cargo tauri build --target ${{ matrix.target }} --bundles ${{ matrix.bundles }} && exit 0
            [ $attempt -lt 3 ] && echo "Attempt $attempt failed, retrying in 30s..." && sleep 30
          done
          exit 1

      - name: Build (Android Tauri)
        if: matrix.android == 'tauri' && needs.check-android-signing.outputs.android == 'true'
        run: cargo tauri android build --apk
        working-directory: toloo-app
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/${{ matrix.ndk }}

      # ── Collect artifacts ─────────────────────────────────────────
      - name: Collect artifacts (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.android == false
        run: |
          mkdir -p dist
          find target/${{ matrix.target }}/release/bundle \
            \( -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" \) \
            -exec cp {} dist/ \;

      - name: Collect artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p dist
          find target/${{ matrix.target }}/release/bundle \
            \( -name "*.msi" -o -name "*.exe" \) \
            -exec cp {} dist/ \;

      - name: Collect artifacts (Android Tauri)
        if: matrix.android == 'tauri' && needs.check-android-signing.outputs.android == 'true'
        run: |
          mkdir -p dist
          find toloo-app/src-tauri/gen/android/app/build/outputs/apk \
            -name "*.apk" ! -name "*unsigned*" -exec cp {} dist/ \;

      - uses: actions/upload-artifact@v4
        if: matrix.android == false || needs.check-android-signing.outputs.android == 'true'
        with:
          name: ${{ matrix.artifact }}
          path: dist/
          if-no-files-found: ignore

  # ────────────────────────────────────────────────────────────────────
  # CLI builds — Linux (static musl) + Windows (static CRT)
  # Pure Rust + bundled SQLite: no system deps on any platform.
  # ────────────────────────────────────────────────────────────────────
  build-cli:
    name: Build (${{ matrix.artifact }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 — fully static musl binary, runs on any Linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: cli-linux-x86_64
            binary: toloo
            musl: true

          # Linux ARM64 — fully static musl binary, cross-compiled
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            artifact: cli-linux-aarch64
            binary: toloo
            musl: true
            cross_linker: aarch64-linux-gnu-gcc

          # Windows x86_64 — static CRT, no MSVC redistributable needed
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: cli-windows-x86_64
            binary: toloo.exe
            musl: false

          # Windows ARM64 — Surface / Snapdragon, static CRT
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact: cli-windows-aarch64
            binary: toloo.exe
            musl: false

          # macOS x86_64 — no Xcode needed for a pure Rust CLI
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: cli-macos-x86_64
            binary: toloo
            musl: false

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: cli-macos-aarch64
            binary: toloo
            musl: false

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.artifact }}

      - name: Install musl tools
        if: matrix.musl == true
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools ${{ matrix.cross_linker && 'gcc-aarch64-linux-gnu' || '' }}

      - name: Build
        run: cargo build -p toloo-cli --release --target ${{ matrix.target }}
        env:
          # Statically link the CRT on Windows — .exe runs on any Win10+ with no redistributables
          RUSTFLAGS: ${{ matrix.musl == false && matrix.os == 'windows-latest' && '-C target-feature=+crt-static' || '' }}
          # Cross-linker for ARM64 Linux (aarch64-linux-gnu-gcc)
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: ${{ matrix.cross_linker || '' }}

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          SUFFIX=$(echo "${{ matrix.artifact }}" | sed 's/^cli-//')
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} \
             dist/toloo-cli-${SUFFIX}
          chmod +x dist/*

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p dist
          SUFFIX=$(echo "${{ matrix.artifact }}" | sed 's/^cli-//')
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} \
             dist/toloo-cli-${SUFFIX}.exe

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/

  # ────────────────────────────────────────────────────────────────────
  # Create GitHub Release — runs after all jobs complete
  # ────────────────────────────────────────────────────────────────────
  release:
    name: Create Release
    needs: [check-android-signing, build, build-cli]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts/ -type f | sort

      - uses: softprops/action-gh-release@v2
        with:
          name: "Toloo ${{ github.ref_name }}"
          prerelease: ${{ contains(github.ref_name, '-') }}
          body: |
            ## Toloo ${{ github.ref_name }}

            | Platform | File | Notes |
            |---|---|---|
            | Linux | `.AppImage` | Portable — runs on any distro (Arch, Fedora, NixOS, …) |
            | Linux | `.deb` | Debian / Ubuntu |
            | Linux | `.rpm` | Fedora / openSUSE / RHEL |
            | Linux CLI (x86_64) | `toloo-cli-linux-x86_64` | Static musl binary, zero system deps |
            | Linux CLI (ARM64) | `toloo-cli-linux-aarch64` | Static musl binary, cross-compiled |
            | Windows x86_64 | `.msi` / `.exe` | Standard 64-bit |
            | Windows ARM64 | `.msi` | Surface / Snapdragon laptops |
            | Android | `*-aarch64-release.apk` | API 24+, ARM64 — full native backend |
            | Android | `*-armv7-release.apk` | API 24+, 32-bit ARM — full native backend |

            **Android sideload**: Settings → Security → Install unknown apps → enable for your file manager, then open the APK.
            **Signing**: Android APKs are only included when `KEYSTORE_BASE64` repo secret is configured.
          files: artifacts/**/*
